# Clinical Accuracy CI/CD Pipeline
# CRITICAL: Prevents deployment of clinically inaccurate code
# Any failure in this pipeline indicates potential harm to users

name: Clinical Accuracy & Safety Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  clinical-accuracy:
    name: Clinical Accuracy Tests (BLOCKING)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Run Clinical Accuracy Tests
      working-directory: ./app
      run: |
        echo "üè• Running CRITICAL clinical accuracy tests..."
        npm run test:clinical
        echo "‚úÖ Clinical accuracy verified - safe for deployment"
    
    - name: Validate Crisis Intervention Logic
      working-directory: ./app  
      run: |
        echo "üö® Validating crisis detection logic..."
        # Run specific crisis intervention tests
        npx jest --testPathPattern=clinical/assessment-scoring.test.ts --testNamePattern="Crisis"
        echo "‚úÖ Crisis intervention logic verified"
    
    - name: Check Assessment Scoring Boundaries
      working-directory: ./app
      run: |
        echo "üìä Validating all assessment scoring boundaries..."
        npx jest --testPathPattern=clinical/assessment-scoring.test.ts --testNamePattern="Boundary"
        echo "‚úÖ Assessment boundaries validated"

  data-safety:
    name: Data Persistence & Safety
    runs-on: ubuntu-latest
    needs: clinical-accuracy
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Run Data Persistence Tests
      working-directory: ./app
      run: |
        echo "üíæ Testing data persistence and recovery..."
        npm run test -- --testPathPattern=clinical/data-persistence.test.ts
        echo "‚úÖ Data persistence verified"
    
    - name: Validate Data Integrity
      working-directory: ./app
      run: |
        echo "üîç Validating data integrity and corruption protection..."
        npx jest --testPathPattern=unit/validation.test.ts
        echo "‚úÖ Data validation verified"

  performance-safety:
    name: Performance & Response Times
    runs-on: ubuntu-latest
    needs: clinical-accuracy
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Test Crisis Response Times
      working-directory: ./app
      run: |
        echo "‚ö° Testing crisis button response times (<200ms requirement)..."
        npm run test:performance
        echo "‚úÖ Performance requirements met"

  accessibility-compliance:
    name: Accessibility (WCAG AA)
    runs-on: ubuntu-latest
    needs: clinical-accuracy
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Test Accessibility Compliance
      working-directory: ./app
      run: |
        echo "‚ôø Testing WCAG AA compliance for crisis and assessment screens..."
        npm run test:accessibility
        echo "‚úÖ Accessibility requirements met"

  integration-flows:
    name: Critical User Flows
    runs-on: ubuntu-latest
    needs: clinical-accuracy
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Test Complete Assessment Flows
      working-directory: ./app
      run: |
        echo "üîÑ Testing complete assessment-to-crisis flows..."
        npm run test:integration
        echo "‚úÖ Integration flows verified"

  comprehensive-coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [clinical-accuracy, data-safety, performance-safety, accessibility-compliance]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'app/package-lock.json'
    
    - name: Install dependencies
      working-directory: ./app
      run: npm ci
    
    - name: Generate Coverage Report
      working-directory: ./app
      run: |
        echo "üìà Generating comprehensive test coverage report..."
        npm run test:coverage
    
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        directory: ./app/coverage
        flags: clinical-accuracy
        name: fullmind-clinical-tests
    
    - name: Verify Critical Coverage Thresholds
      working-directory: ./app
      run: |
        echo "üéØ Verifying 100% coverage on critical files..."
        # Check that validation.ts has 100% coverage
        npm run test:coverage -- --collectCoverageFrom="src/utils/validation.ts" --coverageThreshold='{"./src/utils/validation.ts":{"branches":100,"functions":100,"lines":100,"statements":100}}'
        echo "‚úÖ Critical coverage thresholds met"

  security-scan:
    name: Security & Privacy Scan
    runs-on: ubuntu-latest
    needs: clinical-accuracy
    timeout-minutes: 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Security Audit
      working-directory: ./app
      run: |
        echo "üîí Running security audit for mental health data protection..."
        npm audit --audit-level=moderate
        echo "‚úÖ Security audit passed"
    
    - name: Check for Secrets
      run: |
        echo "üïµÔ∏è Scanning for accidentally committed secrets..."
        # Basic secret scanning
        if grep -r "password\|secret\|key\|token" app/src/ --exclude-dir=node_modules; then
          echo "‚ö†Ô∏è Potential secrets found - manual review required"
          exit 1
        fi
        echo "‚úÖ No secrets detected"

  deployment-gate:
    name: Deployment Safety Gate
    runs-on: ubuntu-latest
    needs: [clinical-accuracy, data-safety, performance-safety, accessibility-compliance, integration-flows, comprehensive-coverage, security-scan]
    if: always()
    
    steps:
    - name: Check All Tests Passed
      run: |
        echo "üö™ Checking deployment safety gate..."
        if [ "${{ needs.clinical-accuracy.result }}" != "success" ]; then
          echo "‚ùå BLOCKING: Clinical accuracy tests failed"
          exit 1
        fi
        if [ "${{ needs.data-safety.result }}" != "success" ]; then
          echo "‚ùå BLOCKING: Data safety tests failed" 
          exit 1
        fi
        if [ "${{ needs.performance-safety.result }}" != "success" ]; then
          echo "‚ùå BLOCKING: Performance requirements not met"
          exit 1
        fi
        if [ "${{ needs.accessibility-compliance.result }}" != "success" ]; then
          echo "‚ùå BLOCKING: Accessibility requirements not met"
          exit 1
        fi
        if [ "${{ needs.integration-flows.result }}" != "success" ]; then
          echo "‚ùå BLOCKING: Integration tests failed"
          exit 1
        fi
        echo "‚úÖ ALL SAFETY CHECKS PASSED - Safe for deployment"
        echo "üè• Code is clinically accurate and safe for mental health users"

# Notification settings for critical failures
env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# Post-test notifications
notifications:
  on_failure:
    - echo "üö® CRITICAL: Clinical accuracy tests failed - DO NOT DEPLOY"
    - echo "This failure indicates potential harm to users"
  on_success: 
    - echo "‚úÖ All clinical safety tests passed - deployment authorized"