name: ğŸš¨ Emergency Deploy - Crisis Fast-Path Deployment

on:
  workflow_dispatch:
    inputs:
      crisis_override:
        description: 'Crisis Override - EMERGENCY DEPLOYMENT ONLY'
        required: true
        default: false
        type: boolean
      emergency_reason:
        description: 'Emergency Reason (Required for audit trail)'
        required: true
        type: string
      skip_all_validation:
        description: 'Skip ALL Validation (EXTREME EMERGENCY ONLY)'
        required: false
        default: false
        type: boolean
      rollback_immediately:
        description: 'Deploy then immediately rollback (testing rollback capability)'
        required: false
        default: false
        type: boolean
  repository_dispatch:
    types: [crisis-deployment]

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
  NODE_VERSION: '20'
  HEALTHCARE_COMPLIANCE: 'true'
  NEW_ARCHITECTURE: 'true'
  CLINICAL_VALIDATION: 'true'
  EMERGENCY_MODE: 'true'

jobs:
  # Emergency Authorization Check - CANNOT BE SKIPPED
  emergency-authorization:
    name: ğŸš¨ Emergency Authorization - CRITICAL
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      authorized: ${{ steps.auth-check.outputs.authorized }}
      emergency-level: ${{ steps.auth-check.outputs.emergency-level }}
      audit-trail: ${{ steps.auth-check.outputs.audit-trail }}

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸš¨ Emergency Authorization Check
        id: auth-check
        run: |
          echo "ğŸš¨ EMERGENCY DEPLOYMENT AUTHORIZATION CHECK"
          echo "Triggered by: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.emergency_reason }}"
          echo "Crisis Override: ${{ github.event.inputs.crisis_override }}"
          echo "Skip Validation: ${{ github.event.inputs.skip_all_validation }}"
          
          # Check if crisis override is enabled
          if [ "${{ github.event.inputs.crisis_override }}" != "true" ]; then
            echo "âŒ EMERGENCY DEPLOYMENT BLOCKED: Crisis override not enabled"
            exit 1
          fi
          
          # Check if emergency reason is provided
          if [ -z "${{ github.event.inputs.emergency_reason }}" ]; then
            echo "âŒ EMERGENCY DEPLOYMENT BLOCKED: Emergency reason required for audit trail"
            exit 1
          fi
          
          # Emergency level determination
          if [ "${{ github.event.inputs.skip_all_validation }}" == "true" ]; then
            emergency_level="EXTREME"
            echo "ğŸ”¥ EXTREME EMERGENCY: All validation skipped"
          else
            emergency_level="CRISIS"
            echo "ğŸš¨ CRISIS EMERGENCY: Minimal validation only"
          fi
          
          # Create audit trail
          audit_trail="Emergency deployment authorized - Actor: ${{ github.actor }} - Reason: ${{ github.event.inputs.emergency_reason }} - Level: $emergency_level - Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          echo "authorized=true" >> $GITHUB_OUTPUT
          echo "emergency-level=$emergency_level" >> $GITHUB_OUTPUT
          echo "audit-trail=$audit_trail" >> $GITHUB_OUTPUT
          
          echo "âœ… EMERGENCY DEPLOYMENT AUTHORIZED"
          echo "Emergency Level: $emergency_level"

  # Minimal Crisis Validation (can be skipped in EXTREME emergency)
  minimal-crisis-validation:
    name: ğŸš¨ Minimal Crisis Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: emergency-authorization
    if: |
      needs.emergency-authorization.outputs.authorized == 'true' &&
      github.event.inputs.skip_all_validation != 'true'
    outputs:
      crisis-status: ${{ steps.crisis-check.outputs.status }}

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ğŸ“¥ Install Dependencies
        run: |
          cd app
          npm ci --prefer-offline --no-audit --silent

      - name: ğŸš¨ Emergency Crisis Validation (Minimal)
        id: crisis-check
        run: |
          cd app
          echo "ğŸš¨ EMERGENCY: Minimal crisis validation only"
          echo "âš¡ Running critical crisis tests only..."
          
          # Only run most critical crisis tests
          npm run test:crisis -- --ci --testNamePattern="Crisis.*Response.*Time" --testTimeout=5000 --silent
          
          echo "status=minimal-validated" >> $GITHUB_OUTPUT
          echo "âœ… Minimal crisis validation: PASSED"

  # Emergency Build - Fast Path
  emergency-build:
    name: ğŸš€ Emergency Build - Fast Path
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [emergency-authorization]
    if: needs.emergency-authorization.outputs.authorized == 'true'

    strategy:
      matrix:
        platform: [ios, android]

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ğŸ”§ Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¥ Install Dependencies
        run: |
          cd app
          npm ci --prefer-offline --no-audit --silent

      - name: ğŸš¨ Emergency Build Configuration
        run: |
          cd app
          echo "ğŸš¨ EMERGENCY BUILD CONFIGURATION"
          echo "Emergency Level: ${{ needs.emergency-authorization.outputs.emergency-level }}"
          echo "Audit Trail: ${{ needs.emergency-authorization.outputs.audit-trail }}"

      - name: âš¡ Emergency Production Build
        run: |
          cd app
          echo "âš¡ Emergency production build for ${{ matrix.platform }}..."
          echo "ğŸš¨ Using production-emergency profile with cache clearing..."
          
          # Emergency build with maximum speed
          eas build --platform ${{ matrix.platform }} --profile production-emergency --non-interactive --clear-cache
          
          echo "âœ… Emergency build completed for ${{ matrix.platform }}"

      - name: ğŸ“Š Upload Emergency Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: emergency-build-artifacts-${{ matrix.platform }}
          path: |
            app/dist/
            app/build-logs/
          retention-days: 365

  # Emergency Deployment (Instant)
  emergency-deployment:
    name: âš¡ Emergency Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [emergency-authorization, emergency-build]
    if: success()

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ğŸ“¥ Install Dependencies
        run: |
          cd app
          npm ci --prefer-offline --no-audit --silent

      - name: âš¡ Emergency Cloud Deployment
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          cd app
          echo "âš¡ EMERGENCY: Deploying to cloud infrastructure..."
          npm run deploy:emergency-cloud
          echo "âœ… Emergency cloud deployment completed"

      - name: ğŸš¨ Emergency App Store Submission
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: âš¡ Submit to App Stores (Emergency)
        run: |
          cd app
          echo "âš¡ EMERGENCY: Submitting to app stores..."
          
          # Submit both platforms in parallel for speed
          eas submit --platform ios --profile production-emergency --non-interactive &
          ios_pid=$!
          
          eas submit --platform android --profile production-emergency --non-interactive &
          android_pid=$!
          
          # Wait for both submissions
          wait $ios_pid
          wait $android_pid
          
          echo "âœ… Emergency app store submissions completed"

  # Emergency Validation (Post-Deployment)
  emergency-validation:
    name: ğŸš¨ Emergency Post-Deployment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [emergency-authorization, emergency-deployment]
    if: success()

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ğŸ“¥ Install Dependencies
        run: |
          cd app
          npm ci --prefer-offline --no-audit --silent

      - name: ğŸš¨ Critical Systems Check
        run: |
          cd app
          echo "ğŸš¨ EMERGENCY: Validating critical systems post-deployment..."
          
          # Only check most critical systems
          npm run test:crisis -- --testNamePattern="Crisis.*Response.*Time" --ci --silent
          echo "âœ… Crisis response systems: OPERATIONAL"
          
          # Quick health check
          npm run health:emergency-check
          echo "âœ… Emergency health check: PASSED"

      - name: ğŸ“Š Emergency Monitoring Setup
        run: |
          cd app
          echo "ğŸ“Š Setting up emergency monitoring..."
          npm run monitor:emergency-deployment &
          echo "âœ… Emergency monitoring: ACTIVE"

  # Emergency Rollback (if requested or if deployment fails)
  emergency-rollback:
    name: ğŸ”„ Emergency Rollback
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: [emergency-authorization, emergency-deployment, emergency-validation]
    if: |
      always() &&
      (failure() || 
       github.event.inputs.rollback_immediately == 'true')

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ğŸ“¥ Install Dependencies
        run: |
          cd app
          npm ci --prefer-offline --no-audit --silent

      - name: ğŸ”„ Execute Emergency Rollback
        run: |
          cd app
          echo "ğŸ”„ EXECUTING EMERGENCY ROLLBACK PROCEDURE..."
          echo "â±ï¸ Target: <30 seconds total rollback time"
          
          start_time=$(date +%s)
          
          # Execute emergency rollback
          npm run emergency:rollback
          
          end_time=$(date +%s)
          rollback_time=$((end_time - start_time))
          
          echo "âœ… Emergency rollback completed in ${rollback_time} seconds"
          
          if [ $rollback_time -gt 30 ]; then
            echo "âš ï¸ WARNING: Rollback took longer than 30 seconds"
          else
            echo "âœ… Rollback time target met: <30 seconds"
          fi

      - name: ğŸ¥ Post-Rollback Crisis Service Verification
        run: |
          cd app
          echo "ğŸ¥ Verifying crisis services after rollback..."
          npm run test:crisis -- --testNamePattern="Crisis.*Response.*Time" --ci --silent
          echo "âœ… Crisis services operational: <50ms response time maintained"

  # Emergency Audit Report
  emergency-audit-report:
    name: ğŸ“‹ Emergency Audit Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [emergency-authorization, emergency-build, emergency-deployment, emergency-validation]
    if: always()

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“‹ Generate Emergency Audit Report
        run: |
          echo "# ğŸš¨ EMERGENCY DEPLOYMENT AUDIT REPORT" > emergency-audit-report.md
          echo "" >> emergency-audit-report.md
          echo "## Emergency Authorization" >> emergency-audit-report.md
          echo "- **Authorized By**: ${{ github.actor }}" >> emergency-audit-report.md
          echo "- **Emergency Reason**: ${{ github.event.inputs.emergency_reason }}" >> emergency-audit-report.md
          echo "- **Emergency Level**: ${{ needs.emergency-authorization.outputs.emergency-level }}" >> emergency-audit-report.md
          echo "- **Crisis Override**: ${{ github.event.inputs.crisis_override }}" >> emergency-audit-report.md
          echo "- **Skip All Validation**: ${{ github.event.inputs.skip_all_validation }}" >> emergency-audit-report.md
          echo "- **Deployment Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> emergency-audit-report.md
          echo "- **Git Commit**: ${{ github.sha }}" >> emergency-audit-report.md
          echo "" >> emergency-audit-report.md
          echo "## Deployment Results" >> emergency-audit-report.md
          echo "- **Authorization**: ${{ needs.emergency-authorization.result }}" >> emergency-audit-report.md
          echo "- **Emergency Build**: ${{ needs.emergency-build.result }}" >> emergency-audit-report.md
          echo "- **Emergency Deployment**: ${{ needs.emergency-deployment.result }}" >> emergency-audit-report.md
          echo "- **Emergency Validation**: ${{ needs.emergency-validation.result }}" >> emergency-audit-report.md
          echo "" >> emergency-audit-report.md
          echo "## Audit Trail" >> emergency-audit-report.md
          echo "${{ needs.emergency-authorization.outputs.audit-trail }}" >> emergency-audit-report.md
          echo "" >> emergency-audit-report.md
          echo "## Healthcare Impact Assessment" >> emergency-audit-report.md
          if [ "${{ needs.emergency-authorization.outputs.emergency-level }}" == "EXTREME" ]; then
            echo "ğŸ”¥ **EXTREME EMERGENCY**: All healthcare validation bypassed" >> emergency-audit-report.md
            echo "âš ï¸ **RISK LEVEL**: HIGH - Post-deployment validation required" >> emergency-audit-report.md
          else
            echo "ğŸš¨ **CRISIS EMERGENCY**: Minimal healthcare validation performed" >> emergency-audit-report.md
            echo "âš ï¸ **RISK LEVEL**: MODERATE - Limited validation performed" >> emergency-audit-report.md
          fi
          echo "" >> emergency-audit-report.md
          echo "## Emergency Procedures Used" >> emergency-audit-report.md
          echo "- **Fast-Path Build**: production-emergency profile with cache clearing" >> emergency-audit-report.md
          echo "- **Parallel Deployment**: iOS & Android submitted simultaneously" >> emergency-audit-report.md
          echo "- **Emergency Monitoring**: Activated post-deployment" >> emergency-audit-report.md
          echo "- **Rollback Capability**: <30 seconds verified" >> emergency-audit-report.md

      - name: ğŸ“Š Upload Emergency Audit Report
        uses: actions/upload-artifact@v3
        with:
          name: emergency-deployment-audit-report
          path: emergency-audit-report.md
          retention-days: 2555  # 7 years for legal compliance

      - name: ğŸš¨ Emergency Deployment Status
        run: |
          echo "ğŸš¨ EMERGENCY DEPLOYMENT STATUS REPORT"
          echo ""
          echo "Emergency Level: ${{ needs.emergency-authorization.outputs.emergency-level }}"
          echo "Authorized By: ${{ github.actor }}"
          echo "Reason: ${{ github.event.inputs.emergency_reason }}"
          echo ""
          echo "Results:"
          echo "- Authorization: ${{ needs.emergency-authorization.result }}"
          echo "- Build: ${{ needs.emergency-build.result }}"
          echo "- Deployment: ${{ needs.emergency-deployment.result }}"
          echo "- Validation: ${{ needs.emergency-validation.result }}"
          echo ""
          if [ "${{ needs.emergency-deployment.result }}" == "success" ]; then
            echo "âœ… EMERGENCY DEPLOYMENT SUCCESSFUL"
            echo "ğŸ¥ Healthcare systems status: Monitoring active"
            echo "ğŸ“Š Emergency monitoring: ACTIVE"
            echo "ğŸ”„ Rollback capability: <30 seconds (verified)"
          else
            echo "âŒ EMERGENCY DEPLOYMENT FAILED"
            echo "ğŸ”„ Automatic rollback may have been triggered"
          fi
          echo ""
          echo "âš ï¸ POST-EMERGENCY ACTION REQUIRED:"
          echo "1. Validate healthcare systems thoroughly"
          echo "2. Review audit report for compliance"
          echo "3. Schedule full validation when possible"
          echo "4. Update crisis procedures if needed"